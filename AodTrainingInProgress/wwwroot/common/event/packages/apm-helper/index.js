var apmHelper = function () { "use strict"; var _excluded = ["userId"]; function _typeof(e) { "@babel/helpers - typeof"; return _typeof = typeof Symbol == "function" && typeof Symbol.iterator == "symbol" ? function (r) { return typeof r } : function (r) { return r && typeof Symbol == "function" && r.constructor === Symbol && r !== Symbol.prototype ? "symbol" : typeof r }, _typeof(e) } function _objectWithoutProperties(e, r) { if (e == null) return {}; var t, n, d = _objectWithoutPropertiesLoose(e, r); if (Object.getOwnPropertySymbols) { var p = Object.getOwnPropertySymbols(e); for (n = 0; n < p.length; n++)t = p[n], r.includes(t) || {}.propertyIsEnumerable.call(e, t) && (d[t] = e[t]) } return d } function _objectWithoutPropertiesLoose(e, r) { if (e == null) return {}; var t = {}; for (var n in e) if ({}.hasOwnProperty.call(e, n)) { if (r.includes(n)) continue; t[n] = e[n] } return t } function ownKeys(e, r) { var t = Object.keys(e); if (Object.getOwnPropertySymbols) { var n = Object.getOwnPropertySymbols(e); r && (n = n.filter(function (d) { return Object.getOwnPropertyDescriptor(e, d).enumerable })), t.push.apply(t, n) } return t } function _objectSpread(e) { for (var r = 1; r < arguments.length; r++) { var t = arguments[r] != null ? arguments[r] : {}; r % 2 ? ownKeys(Object(t), !0).forEach(function (n) { _defineProperty(e, n, t[n]) }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (n) { Object.defineProperty(e, n, Object.getOwnPropertyDescriptor(t, n)) }) } return e } function _classCallCheck(e, r) { if (!(e instanceof r)) throw new TypeError("Cannot call a class as a function") } function _defineProperties(e, r) { for (var t = 0; t < r.length; t++) { var n = r[t]; n.enumerable = n.enumerable || !1, n.configurable = !0, "value" in n && (n.writable = !0), Object.defineProperty(e, _toPropertyKey(n.key), n) } } function _createClass(e, r, t) { return r && _defineProperties(e.prototype, r), t && _defineProperties(e, t), Object.defineProperty(e, "prototype", { writable: !1 }), e } function _defineProperty(e, r, t) { return (r = _toPropertyKey(r)) in e ? Object.defineProperty(e, r, { value: t, enumerable: !0, configurable: !0, writable: !0 }) : e[r] = t, e } function _toPropertyKey(e) { var r = _toPrimitive(e, "string"); return _typeof(r) == "symbol" ? r : r + "" } function _toPrimitive(e, r) { if (_typeof(e) != "object" || !e) return e; var t = e[Symbol.toPrimitive]; if (t !== void 0) { var n = t.call(e, r || "default"); if (_typeof(n) != "object") return n; throw new TypeError("@@toPrimitive must return a primitive value.") } return (r === "string" ? String : Number)(e) } var e = typeof window > "u"; function r() { if (e) return { platform: "其他", version: void 0 }; try { for (var s = window.navigator.userAgent, u = [{ name: "微信", regex: /MicroMessenger\/([\d.]+)/i }, { name: "QQ", regex: /QQ\/([\d.]+)/i }, { name: "WeiBo", regex: /WeiBo__([\d.]+)/i }, { name: "小红书", regex: /XiaoHongShu_([\d.]+)_Build/i }, { name: "米游社", regex: /miHoYoBBS\/([\d.]+)/i }, { name: "HoYolab", regex: /miHoYoBBSOversea\/([\d.]+)/i }, { name: "移动端浏览器", regex: /Mobile|Android|iPhone|iPad|iPod/i }, { name: "桌面端浏览器", regex: /Chrome|Firefox|Safari|Edge|Opera/i }], i = 0, o = u; i < o.length; i++) { var a = o[i], l = s.match(a.regex); if (l) { var m = l[1] || void 0; return { platform: a.name, version: m } } } var c = /\((.*?)\)/, v = s.match(c); if (v) { var f = v[1]; if (f.includes("Macintosh")) return { platform: "MacOS", version: void 0 }; if (f.includes("Windows")) return { platform: "Windows", version: void 0 }; if (f.includes("Linux")) return { platform: "Linux", version: void 0 }; if (f.includes("Android")) return { platform: "Android", version: void 0 }; if (f.includes("iPhone") || f.includes("iPad")) return { platform: "iOS", version: void 0 } } return { platform: "其他", version: void 0 } } catch (g) { return console.warn("获取环境信息失败:", g), { platform: "其他", version: void 0 } } } var t = function () { try { var u = new URLSearchParams(window.location.search), i = u.get("lang"); if (i) return i; var o = n("mi18nLang"); return o || "" } catch (a) { return console.warn("获取语言信息失败:", a), "" } }; function n(s) { if (typeof document > "u") return ""; var u = "; ".concat(document.cookie), i = u.split("; ".concat(s, "=")); if (i.length === 2) { var o; return ((o = i.pop()) === null || o === void 0 ? void 0 : o.split(";").shift()) || "" } return "" } var d = function () { var u = arguments.length > 0 && arguments[0] !== void 0 ? arguments[0] : window.location.href, i = arguments.length > 1 && arguments[1] !== void 0 ? arguments[1] : !1, o = {}, a = null, l = /[?&](.*?)=([^&#]*)/g; for (i && (u = u.replace(/#.*?$/, "")), a = l.exec(u); a;) { try { o[a[1]] = decodeURIComponent(a[2]) } catch { try { o[a[1]] = unescape(a[2]) } catch { o[a[1]] = a[2] } } a = l.exec(u) } return o }, p = function () { return n("lrsag") === "1" || n("e_lrsag") === "1" || d().lrsag === "1" }, y = function () { function s() { _classCallCheck(this, s), _defineProperty(this, "user", null), _defineProperty(this, "environment", null), _defineProperty(this, "isInitialized", !1), this.init() } return _createClass(s, [{ key: "init", value: function () { if (typeof window > "u") { console.warn("APM Helper: 当前环境不是浏览器"); return } if (typeof window.apmPlus > "u") { console.warn("APM Helper: APM SDK 未初始化"); return } this.isInitialized || (this.setUser(null), this.setEnvironment(), this.isInitialized = !0) } }, { key: "setUser", value: function (i) { var o; if (!(typeof window > "u" || typeof window.apmPlus > "u")) { if (p()) { console.warn("APM Helper: 当前是 U13 用户，不设置用户信息"); return } var a = n("account_id_v2") || "", l = n("ltuid_v2") || "", m = { account_id_v2: a, ltuid_v2: l }, c = (i == null ? void 0 : i.userId) || ((o = this.user) === null || o === void 0 ? void 0 : o.userId) || a || l; window.__APM_USER_ID__ = c, this.user = _objectSpread(_objectSpread(_objectSpread(_objectSpread({}, this.user || {}), i || {}), m), {}, { userId: c }), c && window.apmPlus("config", { userId: c }); var v = this.user, f = v.userId, g = _objectWithoutProperties(v, _excluded); window.apmPlus("context.merge", g) } } }, { key: "setEnvironment", value: function (i) { if (!(typeof window > "u" || typeof window.apmPlus > "u")) { var o = r(); this.environment = _objectSpread(_objectSpread({}, o), {}, { language: t() }), i != null && i.env && (this.environment.env = i.env), window.apmPlus("context.merge", this.environment) } } }, { key: "getStatus", value: function () { return { initialized: this.isInitialized, user: this.user, environment: this.environment } } }]) }(), h = new y; return h }();
